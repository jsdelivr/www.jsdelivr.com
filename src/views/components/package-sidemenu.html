<div class="c-package-sidemenu">
	<div class="package-stats {{navRoute === 'stats' ? 'move-top' : ''}}">
		<div class="block-shadow {{navRoute === 'config' ? 'bottom' : navRoute === 'stats' ? 'top' : ''}}"></div>

		<div style="position: relative; z-index: 1;{{#unless navRoute !== 'stats'}}display: none;{{/unless}}">
			<div class="sidemenu-title">
				<span>Statistics</span>

				<div class="btn-group">
					<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						<span>{{statsPeriodValues[statsPeriod]}}</span>
						<i class="fa fa-angle-down" aria-hidden="true"></i>
					</button>

					<ul class="dropdown-menu">
						{{#each statsPeriodValues}}
							<li><a on-click="@this.set('statsPeriod', @key)">{{this}}</a></li>
						{{/each}}
					</ul>
				</div>
			</div>

			<div class="horizontal-divider mt-24 mb-24"></div>

			<div class="stats-section mb-24">
				<span>Requests Served</span>
				<span>{{noDataOfVersions ? 'No data' : _.formatNumber(packageTotal)}}</span>
			</div>

			<div class="requests-chart-wrapper">
				{{#if noDataOfRequests}}
					<img src="{{@shared.assetsHost}}/img/no-data-chart-side.svg" class="empty-chart" width="294" height="56">
				{{else}}
					<canvas id="requests-chart"></canvas>
				{{/if}}
			</div>

			<div class="horizontal-divider mt-24 mb-24"></div>

			<div class="stats-section mb-24">
				<span>Bandwidth</span>
				<span>{{noDataOfBandwidth ? 'No data': _.formatNumber(bandwidthTotal) + ' GB'}}</span>
			</div>

			<div class="bandwidth-chart-wrapper">
				{{#if noDataOfBandwidth}}
					<img src="{{@shared.assetsHost}}/img/no-data-chart-side.svg" class="empty-chart" width="294" height="56">
				{{else}}
					<canvas id="bandwidth-chart"></canvas>
				{{/if}}
			</div>

			<div class="horizontal-divider mt-24 mb-24"></div>
		</div>

		<div class="stats-section mb-24">
			<!-- show package version if no data of top versions -->
			<span>Top version - {{noDataOfVersions ? package.version : versionStats[0].version}}</span>
			<span>{{noDataOfVersions ? 'No data' : _.formatNumber(topVersionHits)}}</span>
		</div>

		{{#if navRoute !== "config"}}
			<a on-click="@this.set('navRoute', 'stats')" class="btn-secondary">Full {{name}} Download Stats</a>

			
			{{#unless noDataOfVersions}}
				<div class="horizontal-divider mt-24 mb-24"></div>

				<div class="twitter-share">
					<div>{{_.nth(packageRank)}} most popular on jsDelivr</div>
					<a class="btn-twitter-share mt-8"
						target="_blank"
						rel="noopener noreferrer"
						href="https://twitter.com/intent/tweet?text={{encodeURIComponent(`${name} is the ${_.nth(packageRank)} most popular package on @jsDelivr CDN, with ${_.formatNumber(packageTotal)} hits in the last ${statsPeriodValues[~/statsPeriod]}: ${~/link}`)}}">
						<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/twitter-white.svg">
						Share
					</a>
				</div>
			{{/unless}}

			{{#if package.keywords}}
				<div class="stats-keywords mt-32">
					<div class="stats-keywords-header">Keywords</div>
					<div class="stats-keywords-badges {{#if navRoute === 'stats'}}shortened{{/if}}">
						{{#each package.keywords}}
							<div class="keyword-badge">{{this}}</div>
						{{/each}}
						{{#if navRoute === 'stats'}}
							<div class="badge-cover"></div>
						{{/if}}
					</div>
				</div>
			{{/if}}
		{{/if}}
	</div>

	{{#if navRoute !== "config"}}
		<div class="box-badge mt-32 mb-32">
			<div class="box-title">Get a badge for your package</div>
			<img src="https://data.jsdelivr.com/v1/package/{{~/type || 'npm'}}/{{name}}/badge{{#if ~/badgeAltStyle}}?style=rounded{{/if}}">
			<img as-clipboard="'Copy markdown to clipboard', 'bottom'"
				data-clipboard-text="[![](https://data.jsdelivr.com/v1/package/{{~/type}}/{{~/name}}/badge{{#if ~/badgeAltStyle}}?style=rounded{{/if}})](https://www.jsdelivr.com/package/{{~/type}}/{{~/name}})"
				width="20"
				height="20"
				src="{{@shared.assetsHost}}/img/icons/copy-btn-black.svg">
			<img as-tooltip="'Alternate badge style', 'bottom'"
				on-click="@this.toggle('badgeAltStyle')"
				width="20"
				height="20"
				src="{{@shared.assetsHost}}/img/icons/alternate-btn.svg">
		</div>
	{{/if}}
</div>


<script>
	const _ = require('../../public/js/_');
	const clipboard = require('../../public/js/decorators/clipboard');
	const tooltip = require('../../public/js/decorators/tooltip');
	const http = require('../../public/js/utils/http');
	const createBarChart = require('../../public/js/utils/create-bar-chart');

	component.exports = {
		data () {
			return {
				_,
				statsPeriodValues: {
					1: 'day',
					7: 'week',
					30: 'month',
					365: 'year',
				},
				statsPeriod: 30,
				noDataOfRequests: false,
				noDataOfBandwidth: false,
				noDataOfVersions: false,
				packageTotal: 0,
				topVersionHits: 0,
				bandwidthTotal: 0,
			};
		},
		decorators: {
			clipboard,
			tooltip,
		},
		oninit () {
			if (!Ractive.isServer) {
				this.observe('statsPeriod', () => {
					if (this.get('statsPeriod')) {
						let type = this.get('type');
						let name = this.get('name');
						let statsPeriodValues = this.get('statsPeriodValues');
						let statsPeriod = this.get('statsPeriod');
						let period = statsPeriodValues[statsPeriod];

						// get package version stats
						http.fetchPackageVersionStats(type, name, period).then((data) => {
							if (data.total) {
								let versionsStatsArr = [];

								Object.keys(data.versions).forEach((key) => {
									versionsStatsArr.push({
										version: key,
										hits: data.versions[key].total,
									});
								});

								let versionStats = versionsStatsArr.sort((a, b) => b.hits - a.hits);

								this.animate('versionStats', versionStats, { duration: 1000 });
								this.animate('packageTotal', data.total, { duration: 1000 });
								this.animate('packageRank', data.rank + 1, { duration: 1000 });
								this.animate('topVersionHits', versionStats[0].hits, { duration: 1000 });
							} else {
								this.set('noDataOfVersions', true);
							}
						});

						// get package date stats
						http.fetchPackageDateStats(type, name, period).then((response) => {
							if (response.total) {
								this.set('packageDateStats', response);
							} else {
								this.set('noDataOfRequests', true);
							}
						});

						// get package bandwidth stats
						http.fetchPackageBandwidthStats(type, name, period).then((response) => {
							if (response.total) {
								this.set('packageBandwidthStats', response);
								this.animate('bandwidthTotal', _.convertBytesToUnits(response.total), { duration: 1000 });
							} else {
								this.set('noDataOfBandwidth', true);
							}
						});
					}
				});

				this.observe('packageDateStats navRoute', () => {
					if (this.get('navRoute') === 'stats') {
						return null;
					}

					let requestsChart = this.get('requestsChart');
					let packageDateStats = this.get('packageDateStats');

					if (!packageDateStats) {
						return null;
					}

					let array = [];

					Object.keys(packageDateStats.dates).forEach((date) => {
						array.push([ date, packageDateStats.dates[date] ]);
					});

					array.sort((a, b) => new Date(a[0]) - new Date(b[0]));

					if (requestsChart) {
						requestsChart.destroy();
						requestsChart = null;
						this.set('requestsChart', null);
					}

					let labels = array.map(value => _.formatDate(new Date(value[0])).toUpperCase());
					let data = array.map(value => value[1].total);

					// temp solution to fix chart recreation after switching from stats tab
					setTimeout(() => {
						let chartEl = this.find('#requests-chart');
						let chartData = {
							labels,
							datasets: [{
								data,
								borderWidth: 0,
								barThickness: 4,
								hoverBackgroundColor: '#F65128',
								borderRadius: 1,
							}],
						};
						let chartSettings = {
							useExternalTooltip: true,
							externalTooltipId: 'packageSidemenuRequestsChartTooltip',
							externalTooltipVerticalOffset: 40,
						};
						let chartConfig = {};

						requestsChart = createBarChart(chartEl, chartData, chartSettings, chartConfig);

						this.set('requestsChart', requestsChart);
					}, 100);
				});

				this.observe('packageBandwidthStats navRoute', () => {
					if (this.get('navRoute') === 'stats') {
						return null;
					}

					let bandwidthChart = this.get('bandwidthChart');
					let packageBandwidthStats = this.get('packageBandwidthStats');

					if (!packageBandwidthStats) {
						return null;
					}

					let array = [];

					Object.keys(packageBandwidthStats.dates).forEach((date) => {
						array.push([ date, packageBandwidthStats.dates[date] ]);
					});

					array.sort((a, b) => new Date(a[0]) - new Date(b[0]));

					if (bandwidthChart) {
						bandwidthChart.destroy();
						bandwidthChart = null;
						this.set('bandwidthChart', null);
					}

					let labels = array.map(value => _.formatDate(new Date(value[0])).toUpperCase());
					let data = array.map(value => _.convertBytesToUnits(value[1].total));

					// temp solution to fix chart recreation after switching from stats tab
					setTimeout(() => {
						let chartEl = this.find('#bandwidth-chart');

						let chartData = {
							labels,
							datasets: [{
								data,
								borderWidth: 0,
								barThickness: 4,
								hoverBackgroundColor: '#F65128',
								borderRadius: 1,
							}],
						};
						let chartSettings = {
							useExternalTooltip: true,
							externalTooltipId: 'packageSidemenuBandwidthChartTooltip',
							externalTooltipVerticalOffset: 40,
						};
						let chartConfig = {};

						bandwidthChart = createBarChart(chartEl, chartData, chartSettings, chartConfig);

						this.set('bandwidthChart', bandwidthChart);
					}, 100);
				});
			}
		},
	};
</script>