<div class="c-package-header">
	{{#with package}}
		<div class="row">
			<div class="col-sm-8">
				<div class="package-name-wrapper">
					{{#if onlyHeader}}
						<a href="/package/npm/{{name}}" class="package-name">{{name}}</a>
					{{else}}
						<h1 class="package-name">{{name}}</h1>
					{{/if}}
				</div>

				<div class="package-info">
					{{#if ~/type === 'gh'}}
						<a target="_blank" rel="noopener noreferrer" href="https://github.com/{{owner.name}}" class="package-owner">
							<img width="20" height="20" src="{{owner.avatar}}?s=20">
							{{owner.name}}
						</a>
					{{else}}
						<a href="/?query=author%3A%20{{owner.name}}" class="package-owner">
							<img width="20" height="20" src="{{owner.avatar}}?s=20" loading="lazy">
							{{owner.name}}
						</a>
					{{/if}}

					{{#if popular}}
						<span class="package-label package-label-primary" title="Popular">popular</span>
					{{/if}}

					{{#if moduleTypes.indexOf('esm') !== -1}}
						<span class="package-label package-label-secondary" title="ESM">esm</span>
					{{/if}}

					{{#if deprecated}}
						<span class="package-label package-label-danger" title="Deprecated">deprecated</span>
					{{/if}}

					{{#if ~/packageVersionsNotFound}}
						<div class="text-center package-no-release">
							This package doesn't have any release on GitHub.<br>
							Please <a target="_blank" href="{{issueReleaseRequest}}">ask the author</a> to make a GitHub release in order to use jsDelivr CDN.<br>

							{{#if ~/latestCommitSha}}
								Alternatively, you can use a <a target="_blank" rel="noopener noreferrer" href="https://cdn.jsdelivr.net/gh/{{githubRepo.user}}/{{githubRepo.project}}@{{~/latestCommitSha}}/">specific git commit hash</a>.
							{{/if}}
						</div>
					{{/if}}
				</div>
			</div>

			<div class="col-sm-4">
				<div class="package-buttons">
					{{#if !~/type || ~/type === 'npm'}}
					<a target="_blank" rel="noopener noreferrer" href="https://openbase.com/js/{{name}}" class="button" title="{{name}} docs & info">
						<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/openbase.svg" alt="{{name}} JS library on Openbase" title="{{name}} docs & info">
					</a>
					{{#if homepage}}
					<a target="_blank" rel="noopener noreferrer nofollow" href="{{homepage}}" class="button" title="Homepage">
						<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/globe.svg" alt="{{name}} JS library homepage" title="{{name}} homepage">
					</a>
					{{/if}}
					{{#if githubRepo}}
					<a target="_blank" rel="noopener noreferrer" href="https://github.com/{{githubRepo.user}}/{{githubRepo.project}}/" class="button" title="GitHub">
						<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/github.svg" alt="{{name}} JS library on GitHub" title="{{name}} on GitHub">
					</a>
					{{/if}}
					<a target="_blank" rel="noopener noreferrer" href="https://www.npmjs.com/package/{{name}}" class="button" title="npm">
						<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/npm.svg" alt="{{name}} JS library on npm" title="{{name}} on npm">
					</a>
					<a rel="noopener noreferrer" href="https://registry.npmjs.org/{{name}}/-/{{name.split('/').slice(-1)[0]}}-{{~/version}}.tgz" class="button" title="Download">
						<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/download.svg" alt="Download {{name}} JS library" title="Download {{name}}">
					</a>
					{{else}}
					<a target="_blank" rel="noopener noreferrer" href="https://github.com/{{githubRepo.user}}/{{githubRepo.project}}/" class="button" title="GitHub">
						<i class="fa fa-github" aria-hidden="true"></i>
					</a>
					{{/if}}
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-xs-12">
				<p class="package-description">
					{{{description}}}
				</p>

				{{#if !onlyHeader}}
					<div class="horizontal-divider-16"></div>
				{{/if}}

				{{#if version}}
					<span class="package-label package-label-neutral" title="{{version}}">Version <span>{{version}}</span></span>
				{{/if}}

				{{#if license}}
					<span class="package-label package-label-neutral" title="{{_.unescapeHtml(license)}}">License <span>{{_.unescapeHtml(license)}}</span></span>
				{{/if}}

				{{#if ~/vulnerabilities !== undefined}}
					<span class="package-label package-label-neutral" title="view details at snyk.io">
						Vulnerabilities <span>{{~/vulnerabilities}}</span>
					</span>
				{{/if}}
			</div>
		</div>

		{{#if !onlyHeader}}
			<div class="row">
				<div class="col-xs-12">
					<div class="package-install-wrapper">
						<div class="install-settings">
							<div>INSTALL</div>
							<div class="dropdown-wrapper">
								<label for="type-select">Type:&nbsp;&nbsp;</label>
								<div class="btn-group">
									<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<span>{{~/selectedType}}</span>
										<i class="fa fa-angle-down" aria-hidden="true"></i>
									</button>

									<ul class="dropdown-menu">
										{{#each ~/typesList}}
											<li><a on-click="@this.set('selectedType', this)">{{this}}</a></li>
										{{/each}}
									</ul>
								</div>
							</div>

							<div class="dropdown-wrapper">
								<label for="version-select">Version:&nbsp;&nbsp;</label>
								<div class="btn-group">
									<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<span>{{~/selectedVersion}}</span>
										<i class="fa fa-angle-down" aria-hidden="true"></i>
									</button>

									<ul class="dropdown-menu">
										{{#each ~/versionsList}}
											<li><a on-click="@this.set('selectedVersion', this)">{{this}}</a></li>
										{{/each}}
									</ul>
								</div>
							</div>
						</div>

						<div class="horizontal-divider-19"></div>

						<div class="install-script">
							{{#if selectedType === "Default"}}
								{{#if ~/packageJsEntrypoint}}
									<div class="script-wrapper-default">
										<span class="script-tag">&#60;script src="</span>
										<span class="script-text">{{~/installScriptSrc}}</span>
										<span class="script-tag">"&#62;&#60;/script&#62;</span>
										<div class="btn-group">
											<button title="Copy to Clipboard" type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
												<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/copy-btn.svg">
											</button>
					
											<ul class="dropdown-menu">
													<li>
														<a as-clipboard="'Copy URL to clipboard', 'right'"
															data-clipboard-text="{{~/installScriptSrc}}">
															Copy URL
														</a>
													</li>

													{{#if ~/packageJsHash}}
														<li>
															<a as-clipboard="'Copy SRI to clipboard', 'right'"
																data-clipboard-text="{{buildIntegrity(~/packageJsHash)}}">
																Copy SRI
															</a>
														</li>
													{{/if}}

													{{#if canBuildHtml(~/installScriptSrc)}}
														<li>
															<a as-clipboard="'Copy HTML to clipboard', 'right'"
																data-clipboard-text="{{buildHtml(~/installScriptSrc)}}">
																Copy HTML
															</a>
														</li>
														{{#if ~/packageJsHash}}
															<li>
																<a as-clipboard="'Copy HTML + SRI to clipboard', 'right'"
																	data-clipboard-text="{{buildHtml(~/installScriptSrc, ~/packageJsHash)}}">
																	Copy HTML + SRI
																</a>
															</li>
														{{/if}}
													{{/if}}
											</ul>
										</div>
									</div>
								{{/if}}

								{{#if ~/packageCssEntrypoint}}
									<div class="script-wrapper-default">
										<span class="script-tag">&#60;link href="</span>
										<span class="script-text">{{~/installLinkHref}}</span>
										<span class="script-tag">" rel="stylesheet"&#62;&#60;/link&#62;</span>
										<div class="btn-group">
											<button title="Copy to Clipboard" type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
												<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/copy-btn.svg">
											</button>
					
											<ul class="dropdown-menu">
													<li>
														<a as-clipboard="'Copy URL to clipboard', 'right'"
															data-clipboard-text="{{~/installLinkHref}}">
															Copy URL
														</a>
													</li>
													{{#if ~/packageCssHash}}
														<li>
															<a as-clipboard="'Copy SRI to clipboard', 'right'"
																data-clipboard-text="{{buildIntegrity(~/packageCssHash)}}">
																Copy SRI
															</a>
														</li>
													{{/if}}

													{{#if canBuildHtml(~/installLinkHref)}}
														<li>
															<a as-clipboard="'Copy HTML to clipboard', 'right'"
																data-clipboard-text="{{buildHtml(~/installLinkHref)}}">
																Copy HTML
															</a>
														</li>
														{{#if ~/packageCssHash}}
															<li>
																<a as-clipboard="'Copy HTML + SRI to clipboard', 'right'"
																	data-clipboard-text="{{buildHtml(~/installLinkHref, ~/packageCssHash)}}">
																	Copy HTML + SRI
																</a>
															</li>
														{{/if}}
													{{/if}}
											</ul>
										</div>
									</div>
								{{/if}}
							{{else}}
								<div class="script-wrapper-esm">
									<span class="script-tag">&#60;script type="module"&#62;</span>
									<span class="script-text">&nbsp;&nbsp;&nbsp;&nbsp;import {{name}} from 'https://cdn.jsdelivr.net/npm/{{name}}/+esm'</span>
									<span class="script-tag">&#60;/script&#62;</span>
								</div>
							{{/if}}
						</div>

						<div class="horizontal-divider-19"></div>

						{{#if selectedType === "Default"}}
							<div class="install-default-warning">
								URL is guessed and might not be correct.
								<a target="_blank" rel="noopener noreferrer" href="https://cdn.jsdelivr.net/npm/{{name}}/">Browse the NPM package</a>
								to find the correct one or use our
								<a on-click="@this.set('navRoute', 'config')">configurator to combine files and generate SRI</a>
							</div>
						{{else}}
							<div class="install-esm-ctrls">
								<a href="https://esm.run/{{name}}" class="esm-ctrl" target="_blank" rel="noopener noreferrer">Open in new tab</a>

								<form class="jsfiddle-form" action="https://jsfiddle.net/api/post/library/pure" method="POST" target="_blank">
									<input type="hidden" name="title" value="esm.run {{name}} demo">
									<input type="hidden" name="js" value="{{jsFiddleJsCode}}" twoway="false">
									<button type="submit" class="esm-ctrl" tabindex="2">Open in jsfiddle</button>
								</form>

								<a href="https://www.jsdelivr.com/esm" class="esm-ctrl" target="_blank" rel="noopener noreferrer">Learn more</a>
							</div>
						{{/if}}
					</div>
				</div>
			</div>
		{{/if}}
	{{/with}}
</div>

<script>
	const _ = require('../../public/js/_');
	const http = require('../../public/js/utils/http');
	const clipboard = require('../../public/js/decorators/clipboard');
	const { buildIntegrity, canBuildHtml, buildHtml } = require('../../public/js/utils/build-links');

	component.exports = {
		computed: {
			issueReleaseRequest () {
				return `https://github.com/${this.get('package.githubRepo.user')}/${this.get('package.githubRepo.project')}/issues/new/`
					+ `?title=No package release on GitHub`
					+ `&body=[This package](${this.get('@global.location.href')}) doesn't have any [GitHub release](https://help.github.com/articles/about-releases/). Could you please create one, so that people can use this project from jsDelivr CDN?`;
			},
			importName () {
				let name = this.get('name').split(/[ ._-]/g).reduce((acc, value) => {
					return acc + value.substr(0, 1).toUpperCase() + value.substr(1);
				}).replace(/[^a-zA-Z0-9_$]/g, '');

				if (/^\d/.test(name)) {
					return `_${name}`;
				}

				return name || 'm';
			},
			jsFiddleJsCode () {
				return `// See https://www.npmjs.com/package/${this.get('name')} documentation.\nimport * as ${this.get('importName')} from 'https://esm.run/${this.get('name')}';\n\nconsole.log(${this.get('importName')})\n`;
			},
		},
		oninit () {
			if (this.get('type') === 'npm' && !this.get('onlyHeader')) {
				this.observe('version', (newValue) => {
					if (newValue) {
						http.fetchPackageVulnerabilities(this.get('name'), newValue).then((data) => {
							this.set('vulnerabilities', data.vulns);
							this.set('vulnerabilitiesUrl', data.url);
						}).catch((error) => {
							this.set('vulnerabilities', undefined);
							console.error('Failed to fetch vulnerability info', error);
						});
					}
				});
			}

			this.observe('packageVersionsNotFound', (newValue) => {
				if (newValue) {
					http.fetchProjectCommits(this.get('package.githubRepo.user'), this.get('package.githubRepo.project')).then((data) => {
						this.set('latestCommitSha', data[0] && data[0].sha);
					});
				}
			});

			this.observe('selectedVersion', () => {
				if (this.get('onlyHeader')) {
					return;
				}

				let installPackageVersion = '';
				let selectedVersion = this.get('selectedVersion');
				let packageName = this.get('name');
				let packageVersion = this.get('version');
				let packageType = this.get('type');

				if (selectedVersion === 'Static') {
					installPackageVersion = packageVersion;
				} else if (selectedVersion === 'Major') {
					installPackageVersion = packageVersion.split('.')[0];
				} else if (selectedVersion === 'Minor') {
					installPackageVersion = packageVersion.split('.').slice(0, 2).join('.');
				} else {
					installPackageVersion = 'latest';
				}

				http.fetchPackageEntrypoints(packageType, packageName, packageVersion).then((data) => {
					let packageJsEntrypoint = '';
					let packageCssEntrypoint = '';

					if (data.js) {
						packageJsEntrypoint = data.js.file;
						this.set('installScriptSrc', `https://cdn.jsdelivr.net/${packageType}/${packageName}@${installPackageVersion}${packageJsEntrypoint}`);
						this.set('packageJsEntrypoint', packageJsEntrypoint);
					}

					if (data.css) {
						packageCssEntrypoint = data.css.file;
						this.set('installLinkHref', `https://cdn.jsdelivr.net/${packageType}/${packageName}@${installPackageVersion}${packageCssEntrypoint}`);
						this.set('packageCssEntrypoint', packageCssEntrypoint);
					}

					http.fetchPackageFiles(packageType, packageName, packageVersion, 'flat').then((data) => {
						if (packageJsEntrypoint) {
							data.files.forEach((file) => {
								if (file.name === this.get('packageJsEntrypoint')) {
									this.set('packageJsHash', file.hash);
								}
							});
						}

						if (packageCssEntrypoint) {
							data.files.forEach((file) => {
								if (file.name === this.get('packageCssEntrypoint')) {
									this.set('packageCssHash', file.hash);
								}
							});
						}
					});
				});
			});

			this.observe('package.moduleTypes', (value) => {
				if (
					this.get('onlyHeader') !== true
					&& (value.indexOf('esm') !== -1 || value.indexOf('cjs') !== -1)
				) {
					this.set('selectedType', 'ESM');
				}
			});
		},
		data () {
			return {
				_,
				typesList: [
					'Default',
					'ESM',
				],
				versionsList: [
					'Static',
					'Major',
					'Minor',
					'Latest',
				],
				selectedType: 'Default',
				selectedVersion: 'Static',
				buildIntegrity,
				canBuildHtml,
				buildHtml,
			};
		},
		decorators: {
			clipboard,
		},
	};
</script>
