<div class="c-request-bandwidth-stats">
	<div>
		<div class="card-icon">
			<img width="32" height="32" src="{{@shared.assetsHost}}/img/icons/request.alt.svg">
		</div>
		<div class="card-main-stat">
			<div><span class="text-table-number">{{_.formatNumber(requestsAmount)}}</span></div>
			<div><span>Requests Served</span></div>
		</div>
		<div class="card-growth">
			<div class="{{#if requestsGrowthPercent>=0}}growth-positive{{else}}growth-negative{{/if}}">
				<span class="text-table-number">{{#if requestsGrowthPercent>0}}+{{/if}}{{requestsGrowthPercent}}%</span>
			</div>
			<div><span>{{growthPeriod}} {{#if requestsGrowthPercent>=0}}growth{{else}}decline{{/if}}</span></div>
		</div>
	</div>

	<div>
		<div class="card-icon">
			<img width="32" height="32" src="{{@shared.assetsHost}}/img/icons/transfer.alt.svg">
		</div>
		<div class="card-main-stat">
			<div><span class="text-table-number">{{_.formatNumber(bandwidthAmount)}} {{bandwidthUnit}}</span></div>
			<div><span>Bandwidth</span></div>
		</div>
		<div class="card-growth">
			<div class="{{#if bandwidthGrowthPercent>=0}}growth-positive{{else}}growth-negative{{/if}}">
				<span class="text-table-number">{{#if bandwidthGrowthPercent>0}}+{{/if}}{{bandwidthGrowthPercent}}%</span>
			</div>
			<div><span>{{growthPeriod}} {{#if bandwidthGrowthPercent>=0}}growth{{else}}decline{{/if}}</span></div>
		</div>
	</div>
</div>

<script>
	const _ = require('../../public/js/_');
	const http = require('../../public/js/utils/http');

	component.exports = {
		data () {
			return {
				_,
				requestsAmount: 0,
				bandwidthAmount: 0,
				requestsGrowthPercent: 0,
				bandwidthGrowthPercent: 0,
				growthPeriods: {
					day: 'daily',
					week: 'weekly',
					month: 'monthly',
					year: 'yearly',
				},
				growthPeriod: 'monthly',
			};
		},
		calculateGrowth (curr, prev) {
			return Math.round((curr / prev) * 100 - 100);
		},
		oninit () {
			if (!Ractive.isServer) {
				this.observe('period', (period) => {
					let name = this.get('name');
					let bandwidthUnit = this.get('bandwidthUnit');
					this.set('growthPeriod', this.get('growthPeriods')[period]);

					http.fetchCdnOssStats(name, period).then(({ hits, bandwidth }) => {
						if (hits.total >= 0) {
							this.animate('requestsAmount', hits.total, { duration: 1000 });
							this.animate('requestsGrowthPercent', this.calculateGrowth(hits.total, hits.prev.total), { duration: 1000 });
						}

						if (bandwidth.total >= 0) {
							if (!bandwidthUnit) {
								bandwidthUnit = _.findUnitFromNumber(bandwidth.total);
								this.set('bandwidthUnit', bandwidthUnit);
							}

							this.animate('bandwidthAmount', _.convertBytesToUnits(bandwidth.total, bandwidthUnit), { duration: 1000 });
							this.animate('bandwidthGrowthPercent', this.calculateGrowth(bandwidth.total, bandwidth.prev.total), { duration: 1000 });
						}
					});
				});
			}
		},
	};
</script>
